template:
  - sensor:
      - name: Solar and battery return on investment
        unique_id: solar_and_battery_return_on_investment
        state: >
          {% set install_costs = 20189.98 %}
          {% set cost_savings_incorrect_start_offset = 506.89 %}
          {{ (states('sensor.total_energy_cost_savings')|float - install_costs - cost_savings_incorrect_start_offset)|round(2) }}
        unit_of_measurement: $
        device_class: monetary
        state_class: total
        icon: mdi:currency-usd
        availability: "{{ has_value('sensor.total_energy_cost_savings') }}"
  - triggers:
      - trigger: time
        at: "00:00:00"
      - trigger: event
        event_type:
          - homeassistant_started
          - event_template_reloaded
    sensor:
      - name: Solar and battery years to break even
        unique_id: solar_and_battery_years_to_break_even
        state: "{{ (-1 * states('sensor.solar_and_battery_return_on_investment')|float / states('sensor.total_energy_cost_savings_yearly')|float)|round(1) }}"
        unit_of_measurement: years
        state_class: measurement
        icon: mdi:calendar
        availability: "{{ has_value('sensor.solar_and_battery_return_on_investment') and has_value('sensor.total_energy_cost_savings_yearly') }}"
      - name: Solar and battery years to beat investment
        unique_id: solar_and_battery_years_to_beat_investment
        state: >
          {% set install_costs = 20189.98 %}
          {% set resale_percentage = 0.4 %}
          {% set investment_monthly_return_rate = 1.06 ** (1/12) %}
          {% set monthly_savings = states('sensor.total_energy_cost_savings_yearly')|float / 12 %}
          {% set months_since_install = (states('sensor.days_since_battery_installation')|float / 365 * 12)|int %}
          {% set months_to_break_even = (-1 * (states('sensor.solar_and_battery_return_on_investment')|float + install_costs * resale_percentage) / monthly_savings)|int %}
          {% set investment = install_costs * investment_monthly_return_rate ** (months_since_install + months_to_break_even) - monthly_savings * (months_since_install + months_to_break_even) %}
          {% set var = namespace(savings = 0, investment = investment, diff = investment, beat_investment_year = None) %}
          {%- for month in range(months_to_break_even, 600) -%}
            {%- set var.savings = var.savings + monthly_savings -%}
            {%- set var.investment = var.investment * investment_monthly_return_rate - monthly_savings -%}
            {%- if var.savings >= var.investment -%}
              {%- set var.beat_investment_year = (month / 12)|round(1) -%}
              {%- break -%}
            {%- elif var.investment - var.savings > var.diff -%}
              {%- break -%}
            {%- endif -%}
            {%- set var.diff = var.investment - var.savings -%}
          {%- endfor -%}
          {{- var.beat_investment_year -}}
        unit_of_measurement: years
        state_class: measurement
        icon: mdi:calendar
        attributes:
          text: "{{ (this.state + ' years') if this.state|int(-100) != -100 else 'never' }}"
        availability: >
          {{
            has_value('sensor.total_energy_cost_savings_yearly') and
            has_value('sensor.days_since_battery_installation') and
            has_value('sensor.solar_and_battery_return_on_investment')
          }}
