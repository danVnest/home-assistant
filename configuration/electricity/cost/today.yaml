utility_meter:
  energy_export_earnings_minus_battery_charging_cost_today:
    name: Energy export earnings minus battery charging cost today
    unique_id: energy_export_earnings_minus_battery_charging_cost_today
    source: sensor.energy_export_earnings_minus_battery_charging_cost
    cycle: daily
  total_energy_cost_today:
    name: Total energy cost today
    unique_id: total_energy_cost_today
    source: sensor.total_energy_cost
    cycle: daily
  grid_cost_today:
    name: Grid cost today
    unique_id: grid_cost_today
    source: sensor.grid_cost
    cycle: daily
  electricity_provider_service_energy_cost_today:
    name: Electricity provider service energy cost today
    unique_id: electricity_provider_service_energy_cost_today
    source: sensor.electricity_provider_service_energy_cost
    cycle: daily
  battery_energy_cost_today:
    name: Battery energy cost today
    unique_id: battery_energy_cost_today
    source: sensor.battery_energy_cost
    cycle: daily
  lights_energy_cost_today:
    name: Lights energy cost today
    unique_id: lights_energy_cost_today
    source: sensor.lights_energy_cost
    cycle: daily
  living_room_aircon_energy_cost_today:
    name: Living room aircon energy cost today
    unique_id: living_room_aircon_energy_cost_today
    source: sensor.living_room_aircon_energy_cost
    cycle: daily
  dining_room_aircon_energy_cost_today:
    name: Dining room aircon energy cost today
    unique_id: dining_room_aircon_energy_cost_today
    source: sensor.dining_room_aircon_energy_cost
    cycle: daily
  bedroom_aircon_energy_cost_today:
    name: Bedroom aircon energy cost today
    unique_id: bedroom_aircon_energy_cost_today
    source: sensor.bedroom_aircon_energy_cost
    cycle: daily
  office_heater_energy_cost_today:
    name: Office heater energy cost today
    unique_id: office_heater_energy_cost_today
    source: sensor.office_heater_energy_cost
    cycle: daily
  nursery_heater_energy_cost_today:
    name: Nursery heater energy cost today
    unique_id: nursery_heater_energy_cost_today
    source: sensor.nursery_heater_energy_cost
    cycle: daily
  fans_energy_cost_today:
    name: Fans energy cost today
    unique_id: fans_energy_cost_today
    source: sensor.fans_energy_cost
    cycle: daily
  humidifier_energy_cost_today:
    name: Humidifiers energy cost today
    unique_id: humidifier_energy_cost_today
    source: sensor.humidifiers_energy_cost
    cycle: daily
  kitchen_appliances_energy_cost_today:
    name: Kitchen appliances energy cost today
    unique_id: kitchen_appliances_energy_cost_today
    source: sensor.kitchen_appliances_energy_cost
    cycle: daily
  dishwasher_energy_cost_today:
    name: Dishwasher energy cost today
    unique_id: dishwasher_energy_cost_today
    source: sensor.dishwasher_energy_cost
    cycle: daily
  fridge_energy_cost_today:
    name: Fridge energy cost today
    unique_id: fridge_energy_cost_today
    source: sensor.fridge_energy_cost
    cycle: daily
  freezer_mini_fridge_routers_energy_cost_today:
    name: Freezer, mini fridge, routers energy cost today
    unique_id: freezer_mini_fridge_routers_energy_cost_today
    source: sensor.freezer_mini_fridge_routers_energy_cost
    cycle: daily
  washer_energy_cost_today:
    name: Washer energy cost today
    unique_id: washer_energy_cost_today
    source: sensor.washer_energy_cost
    cycle: daily
  dryer_energy_cost_today:
    name: Dryer energy cost today
    unique_id: dryer_energy_cost_today
    source: sensor.dryer_energy_cost
    cycle: daily
  tv_speakers_pc_home_assistant_router_relay_security_hub_energy_cost_today:
    name: TV, speakers, PC, Home Assistant, router relay, security hub energy cost today
    unique_id: tv_speakers_pc_home_assistant_router_relay_security_hub_energy_cost_today
    source: sensor.tv_speakers_pc_home_assistant_router_relay_security_hub_energy_cost
    cycle: daily
  water_heater_oven_stove_guest_suite_garage_all_other_energy_cost_today:
    name: Water heater, oven & stove, guest suite, garage, all other energy cost today
    unique_id: water_heater_oven_stove_guest_suite_garage_all_other_energy_cost_today
    source: sensor.water_heater_oven_stove_guest_suite_garage_all_other_energy_cost
    cycle: daily
  office_desk_computer_monitor_cooler_fish_tank_energy_cost_today:
    name: Office desk, computer & monitor, cooler, fish tank energy cost today
    unique_id: office_desk_computer_monitor_cooler_fish_tank_energy_cost_today
    source: sensor.office_desk_computer_monitor_cooler_fish_tank_energy_cost
    cycle: daily
  phone_chargers_energy_cost_today:
    name: Phone chargers energy cost today
    unique_id: phone_chargers_energy_cost_today
    source: sensor.phone_chargers_energy_cost
    cycle: daily
  sensors_energy_cost_today:
    name: Sensors energy cost today
    unique_id: sensors_energy_cost_today
    source: sensor.sensors_energy_cost
    cycle: daily
  paludarium_picture_frame_camera_energy_cost_today:
    name: Paludarium, picture frame, camera energy cost today
    unique_id: paludarium_picture_frame_camera_energy_cost_today
    source: sensor.paludarium_picture_frame_camera_energy_cost
    cycle: daily
  all_standby_energy_cost_today:
    name: Standby energy cost today
    unique_id: all_standby_energy_cost_today
    source: sensor.standby_energy_cost
    cycle: daily

  total_energy_cost_savings_today:
    name: Total energy cost savings today
    unique_id: total_energy_cost_savings_today
    source: sensor.total_energy_cost_savings
    cycle: daily
  battery_energy_cost_savings_today:
    name: Battery energy cost savings today
    unique_id: battery_energy_cost_savings_today
    source: sensor.battery_energy_cost_savings
    cycle: daily
  lights_energy_cost_savings_today:
    name: Lights energy cost savings today
    unique_id: lights_energy_cost_savings_today
    source: sensor.lights_energy_cost_savings
    cycle: daily
  living_room_aircon_energy_cost_savings_today:
    name: Living room aircon energy cost savings today
    unique_id: living_room_aircon_energy_cost_savings_today
    source: sensor.living_room_aircon_energy_cost_savings
    cycle: daily
  dining_room_aircon_energy_cost_savings_today:
    name: Dining room aircon energy cost savings today
    unique_id: dining_room_aircon_energy_cost_savings_today
    source: sensor.dining_room_aircon_energy_cost_savings
    cycle: daily
  bedroom_aircon_energy_cost_savings_today:
    name: Bedroom aircon energy cost savings today
    unique_id: bedroom_aircon_energy_cost_savings_today
    source: sensor.bedroom_aircon_energy_cost_savings
    cycle: daily
  office_heater_energy_cost_savings_today:
    name: Office heater energy cost savings today
    unique_id: office_heater_energy_cost_savings_today
    source: sensor.office_heater_energy_cost_savings
    cycle: daily
  nursery_heater_energy_cost_savings_today:
    name: Nursery heater energy cost savings today
    unique_id: nursery_heater_energy_cost_savings_today
    source: sensor.nursery_heater_energy_cost_savings
    cycle: daily
  fans_energy_cost_savings_today:
    name: Fans energy cost savings today
    unique_id: fans_energy_cost_savings_today
    source: sensor.fans_energy_cost_savings
    cycle: daily
  humidifier_energy_cost_savings_today:
    name: Humidifiers energy cost savings today
    unique_id: humidifier_energy_cost_savings_today
    source: sensor.humidifiers_energy_cost_savings
    cycle: daily
  kitchen_appliances_energy_cost_savings_today:
    name: Kitchen appliances energy cost savings today
    unique_id: kitchen_appliances_energy_cost_savings_today
    source: sensor.kitchen_appliances_energy_cost_savings
    cycle: daily
  dishwasher_energy_cost_savings_today:
    name: Dishwasher energy cost savings today
    unique_id: dishwasher_energy_cost_savings_today
    source: sensor.dishwasher_energy_cost_savings
    cycle: daily
  fridge_energy_cost_savings_today:
    name: Fridge energy cost savings today
    unique_id: fridge_energy_cost_savings_today
    source: sensor.fridge_energy_cost_savings
    cycle: daily
  freezer_mini_fridge_routers_energy_cost_savings_today:
    name: Freezer, mini fridge, routers energy cost savings today
    unique_id: freezer_mini_fridge_routers_energy_cost_savings_today
    source: sensor.freezer_mini_fridge_routers_energy_cost_savings
    cycle: daily
  washer_energy_cost_savings_today:
    name: Washer energy cost savings today
    unique_id: washer_energy_cost_savings_today
    source: sensor.washer_energy_cost_savings
    cycle: daily
  dryer_energy_cost_savings_today:
    name: Dryer energy cost savings today
    unique_id: dryer_energy_cost_savings_today
    source: sensor.dryer_energy_cost_savings
    cycle: daily

  tv_speakers_pc_home_assistant_router_relay_security_hub_energy_cost_savings_today:
    name: TV, speakers, PC, Home Assistant, router relay, security hub energy cost savings today
    unique_id: tv_speakers_pc_home_assistant_router_relay_security_hub_energy_cost_savings_today
    source: sensor.tv_speakers_pc_home_assistant_router_relay_security_hub_energy_cost_savings
    cycle: daily

  water_heater_oven_stove_guest_suite_garage_all_other_energy_cost_savings_today:
    name: Water heater, oven & stove, guest suite, garage, all other energy cost savings today
    unique_id: water_heater_oven_stove_guest_suite_garage_all_other_energy_cost_savings_today
    source: sensor.water_heater_oven_stove_guest_suite_garage_all_other_energy_cost_savings
    cycle: daily
  office_desk_computer_monitor_cooler_fish_tank_energy_cost_savings_today:
    name: Office desk, computer & monitor, cooler, fish tank energy cost savings today
    unique_id: office_desk_computer_monitor_cooler_fish_tank_energy_cost_savings_today
    source: sensor.office_desk_computer_monitor_cooler_fish_tank_energy_cost_savings
    cycle: daily
  phone_chargers_energy_cost_savings_today:
    name: Phone chargers energy cost savings today
    unique_id: phone_chargers_energy_cost_savings_today
    source: sensor.phone_chargers_energy_cost_savings
    cycle: daily
  sensors_energy_cost_savings_today:
    name: Sensors energy cost savings today
    unique_id: sensors_energy_cost_savings_today
    source: sensor.sensors_energy_cost_savings
    cycle: daily
  paludarium_picture_frame_camera_energy_cost_savings_today:
    name: Paludarium, picture frame, camera energy cost savings today
    unique_id: paludarium_picture_frame_camera_energy_cost_savings_today
    source: sensor.paludarium_picture_frame_camera_energy_cost_savings
    cycle: daily
  all_standby_energy_cost_savings_today:
    name: Standby energy cost savings today
    unique_id: all_standby_energy_cost_savings_today
    source: sensor.standby_energy_cost_savings
    cycle: daily

template:
  - sensor:
      - name: Electricity provider service energy cost savings today
        unique_id: electricity_provider_service_energy_cost_savings_today
        state: "0"
        unit_of_measurement: $
        device_class: monetary
        state_class: total
        icon: mdi:currency-usd
      - name: Grid cost
        unique_id: grid_cost
        state: >
          {% set cost_incorrect_start_offset = -478.89 %}
          {% set initial_earnings = 231.51 %}
          {{
            ((states('sensor.total_energy_cost')|float - cost_incorrect_start_offset) -
            states('sensor.battery_energy_cost')|float +
            (states('sensor.energy_export_earnings')|float + initial_earnings))
            |round(2)
          }}
        unit_of_measurement: $
        state_class: total
        icon: mdi:currency-usd
        availability: "{{ has_value('sensor.total_energy_cost') and has_value('sensor.battery_energy_cost') and has_value('sensor.energy_export_earnings') }}"
      - name: Energy export earnings minus battery charging cost
        unique_id: energy_export_earnings_minus_battery_charging_cost
        state: >
          {% set initial_earnings = 231.51 %}
          {{
            (states('sensor.energy_export_earnings')|float +
            initial_earnings -
            states('sensor.battery_energy_cost')|float)
            |round(2)
          }}
        unit_of_measurement: $
        state_class: total
        icon: mdi:currency-usd
        availability: "{{ has_value('sensor.energy_export_earnings') and has_value('sensor.battery_energy_cost') }}"

  - triggers:
      - trigger: time
        at: "00:01:00" # 1 minute delay to ensure daily utility meters update first
      - trigger: event
        event_type:
          - homeassistant_started
          - event_template_reloaded
    sensor:
      - name: Average daily total energy cost
        unique_id: average_daily_total_energy_cost
        state: >
          {% set cost_incorrect_start_offset = -478.89 %}
          {{
            ((states('sensor.total_energy_cost')|float - cost_incorrect_start_offset) /
            states('sensor.days_since_solar_installation')|float)
            |round(2)
          }}
        unit_of_measurement: $/day
        state_class: total
        icon: mdi:currency-usd
        availability: "{{ has_value('sensor.total_energy_cost') and has_value('sensor.days_since_solar_installation') }}"
      - name: Average daily total energy cost savings
        unique_id: average_daily_total_energy_cost_savings
        state: >
          {% set cost_savings_incorrect_start_offset = 506.89 %}
          {{
            ((states('sensor.total_energy_cost_savings')|float - cost_savings_incorrect_start_offset) /
            states('sensor.days_since_solar_installation')|float)
            |round(2)
          }}
        unit_of_measurement: $/day
        state_class: total
        icon: mdi:currency-usd
        availability: "{{ has_value('sensor.total_energy_cost_savings') and has_value('sensor.days_since_solar_installation') }}"
      - name: Average daily grid cost
        unique_id: average_daily_grid_cost
        state: "{{ ((states('sensor.grid_cost')|float) / states('sensor.days_since_solar_installation')|float)|round(2) }}"
        unit_of_measurement: $/day
        state_class: total
        icon: mdi:currency-usd
        availability: "{{ has_value('sensor.grid_cost') and has_value('sensor.days_since_solar_installation') }}"
      - name: Average daily energy export earnings minus battery charging cost
        unique_id: average_daily_energy_export_earnings_minus_battery_charging_cost
        state: >
          {{
            (states('sensor.energy_export_earnings_minus_battery_charging_cost')|float /
            states('sensor.days_since_solar_installation')|float)|round(2)
          }}
        unit_of_measurement: $/day
        state_class: total
        icon: mdi:currency-usd
        availability: "{{ has_value('sensor.energy_export_earnings_minus_battery_charging_cost') and has_value('sensor.days_since_solar_installation') }}"

      - name: Maximum daily total energy cost
        unique_id: maximum_daily_total_energy_cost
        state: "{{ [state_attr('sensor.total_energy_cost_today', 'last_period')|float(0), this.state|float(0)]|max|round(2) }}"
        unit_of_measurement: $/day
        state_class: total
        icon: mdi:currency-usd
      - name: Maximum daily total energy cost savings
        unique_id: maximum_daily_total_energy_cost_savings
        state: "{{ [state_attr('sensor.total_energy_cost_savings_today', 'last_period')|float(0), this.state|float(0)]|max|round(2) }}"
        unit_of_measurement: $/day
        state_class: total
        icon: mdi:currency-usd
      - name: Maximum daily grid cost
        unique_id: maximum_daily_grid_cost
        state: "{{ [state_attr('sensor.grid_cost_today', 'last_period')|float(0), this.state|float(0)]|max|round(2) }}"
        unit_of_measurement: $/day
        state_class: total
        icon: mdi:currency-usd
      - name: Maximum daily energy export earnings minus battery charging cost
        unique_id: maximum_daily_energy_export_earnings_minus_battery_charging_cost
        state: "{{ [state_attr('sensor.energy_export_earnings_minus_battery_charging_cost_today', 'last_period')|float(0), this.state|float(0)]|max|round(2) }}"
        unit_of_measurement: $/day
        state_class: total
        icon: mdi:currency-usd
