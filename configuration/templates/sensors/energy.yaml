- name: Energy cost per kWh
  state: >
    {%- set green_cost = states('input_number.energy_cost_green_power') | float -%}
    {%- if states('sensor.monthly_energy_from_grid') | float < 100 -%}
      {{- states('input_number.energy_cost_first_100kwh_of_month') | float + green_cost -}}
    {%- else -%}
      {{- states('input_number.energy_cost_after_first_100kwh_of_month') | float + green_cost -}}
    {%- endif -%}
  unit_of_measurement: "$/kWh"
  state_class: measurement
- name: Energy cost per Wh
  state: "{{ states('sensor.energy_cost_per_kwh') | float / 1000 }}"
  unit_of_measurement: "$/Wh"
  state_class: measurement
- name: Dan's phone charger power
  state: >
    {%- set current_level = states('sensor.dan_s_phone_battery_level') | float -%}
    {%- set last_level = state_attr('sensor.dan_s_phone_charger_power', 'last_battery_level') | default(current_level) | float -%}
    {%- set last_updated = state_attr('sensor.dan_s_phone_charger_power', 'last_updated') | default(as_timestamp(now())) | float -%}
    {%- set time_diff = (as_timestamp(now()) - last_updated) / 3600 -%}
    {%- if time_diff > 0 and current_level > last_level -%}
      {%- set battery_change = current_level - last_level -%}
      {%- set battery_capacity_wh = 16.7 -%}
      {%- set energy_added_wh = (battery_change / 100) * battery_capacity_wh -%}
      {{- (energy_added_wh / time_diff) | round(2) -}}
    {%- else -%}
      0
    {%- endif -%}
  unit_of_measurement: "W"
  attributes:
    last_battery_level: "{{ states('sensor.dan_s_phone_battery_level') | float }}"
    last_updated: "{{ as_timestamp(now()) }}"
  availability: >
    {{ states('sensor.dan_s_phone_battery_level') not in ['unknown', 'unavailable'] }}
